name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  spm:
    name: SPM Build
    runs-on: macOS-14
    strategy:
      matrix:
        platform: ['iOS_17']
      fail-fast: false
    steps:
      - name: Checkout Repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4
      - name: Prepare Simulator Runtimes
        run: Scripts/github/prepare-simulators.sh ${{ matrix.platform }}
      - name: Build
        run: Scripts/build.swift spm ${{ matrix.platform }}

  validate-strings:
    name: Validate Localized Strings
    runs-on: macOS-14
    steps:
      - name: Checkout Repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4
      - name: Validate Localized Strings
        run: Scripts/ValidateLocalizedStrings.swift

  tuist-build:
    name: Tuist Build (${{ matrix.platform }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - platform: iOS_17
            runner: macOS-14
            device: "iPhone 15 Pro"
            os: "17.5"
          - platform: iOS_18
            runner: macOS-15
            device: "iPhone 16 Pro"
            os: "18.5"
          - platform: iOS_26
            runner: macOS-15
            device: "iPhone 17 Pro"
            os: "26.2"
            xcode-version: '26.2'
      fail-fast: false
    steps:
      - name: Checkout Repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4
      - name: Install mise
        uses: jdx/mise-action@v2
        with:
          experimental: true
      - name: Select Xcode Version
        if: matrix.xcode-version
        run: sudo xcode-select -s /Applications/Xcode_${{ matrix.xcode-version }}.app
      - name: Prepare Simulator Runtimes
        run: Scripts/github/prepare-simulators.sh ${{ matrix.platform }}
      - name: Tuist Install
        run: tuist install --path Example
      - name: Tuist Generate
        run: tuist generate --path Example
      - name: Tuist Build
        run: tuist build --path Example
      - name: Tuist Test - en
        run: tuist test --path Example -d '${{ matrix.device }}' -o ${{ matrix.os }} --platform iOS --result-bundle-path TestResults-${{ matrix.os }}.xcresult "AccessibilitySnapshotDemo (en)"
      - name: Tuist Test - SwiftUI Experimental
        if: matrix.platform != 'iOS_17'
        run: xcodebuild test -workspace Example/AccessibilitySnapshot.xcworkspace -scheme SwiftUIExperimentalDemo -destination 'platform=iOS Simulator,name=${{ matrix.device }},OS=${{ matrix.os }}' -resultBundlePath TestResults-SwiftUI-${{ matrix.os }}.xcresult
      - name: Upload Results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # ratchet:actions/upload-artifact@v4
        if: failure()
        with:
          name: Test Results-(${{ matrix.platform }}).xcresult
          path: TestResults-${{ matrix.os }}.xcresult
      - name: Upload Reference Images
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # ratchet:actions/upload-artifact@v4
        if: failure()
        with:
          name: Reference Images-(${{ matrix.platform }})
          path: Example/SnapshotTests/ReferenceImages
      - name: Upload SwiftUI Test Results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # ratchet:actions/upload-artifact@v4
        if: failure() && matrix.platform != 'iOS_17'
        with:
          name: SwiftUI Test Results-(${{ matrix.platform }}).xcresult
          path: TestResults-SwiftUI-${{ matrix.os }}.xcresult
